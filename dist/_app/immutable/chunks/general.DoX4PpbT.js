const __vite__fileDeps=["./web.N9l6Cvu3.js","./index.C9AwUYvo.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{r as _,C as m}from"./index.C9AwUYvo.js";import{_ as N}from"./preload-helper.D6kgxu3v.js";import{c as C,d as b}from"./stores.Db1ftiGr.js";var O;(function(a){a[a.SCAN_MODE_LOW_POWER=0]="SCAN_MODE_LOW_POWER",a[a.SCAN_MODE_BALANCED=1]="SCAN_MODE_BALANCED",a[a.SCAN_MODE_LOW_LATENCY=2]="SCAN_MODE_LOW_LATENCY"})(O||(O={}));var q;(function(a){a[a.CONNECTION_PRIORITY_BALANCED=0]="CONNECTION_PRIORITY_BALANCED",a[a.CONNECTION_PRIORITY_HIGH=1]="CONNECTION_PRIORITY_HIGH",a[a.CONNECTION_PRIORITY_LOW_POWER=2]="CONNECTION_PRIORITY_LOW_POWER"})(q||(q={}));function S(a){return new DataView(Uint8Array.from(a).buffer)}function A(a){return Array.from(new Uint8Array(a.buffer,a.byteOffset,a.byteLength))}function T(a){return`0000${a.toString(16).padStart(4,"0")}-0000-1000-8000-00805f9b34fb`}function R(a){const e=a.trim().split(" ").filter(t=>t!=="").map(t=>parseInt(t,16));return S(e)}function g(a){return A(a).map(e=>{let t=e.toString(16);return t.length==1&&(t="0"+t),t}).join(" ")}function Y(a){if(typeof a=="string")return a;if(typeof a=="number")return T(a);throw new Error("Invalid UUID")}function k(a){const e={};if(a)return a.forEach((t,n)=>{e[n.toString()]=t}),e}const i=_("BluetoothLe",{web:()=>N(()=>import("./web.N9l6Cvu3.js"),__vite__mapDeps([0,1]),import.meta.url).then(a=>new a.BluetoothLeWeb)}),B=()=>{let a=Promise.resolve();return e=>new Promise((t,n)=>{a=a.then(()=>e()).then(t).catch(n)})};function p(a){return a?B():e=>e()}function u(a){if(typeof a!="string")throw new Error(`Invalid UUID type ${typeof a}. Expected string.`);if(a=a.toLowerCase(),!(a.search(/^[0-9a-f]{8}\b-[0-9a-f]{4}\b-[0-9a-f]{4}\b-[0-9a-f]{4}\b-[0-9a-f]{12}$/)>=0))throw new Error(`Invalid UUID format ${a}. Expected 128 bit string (e.g. "0000180d-0000-1000-8000-00805f9b34fb").`);return a}class U{constructor(){this.scanListener=null,this.eventListeners=new Map,this.queue=p(!0)}enableQueue(){this.queue=p(!0)}disableQueue(){this.queue=p(!1)}async initialize(e){await this.queue(async()=>{await i.initialize(e)})}async isEnabled(){return await this.queue(async()=>(await i.isEnabled()).value)}async requestEnable(){await this.queue(async()=>{await i.requestEnable()})}async enable(){await this.queue(async()=>{await i.enable()})}async disable(){await this.queue(async()=>{await i.disable()})}async startEnabledNotifications(e){await this.queue(async()=>{var t;const n="onEnabledChanged";await((t=this.eventListeners.get(n))===null||t===void 0?void 0:t.remove());const s=await i.addListener(n,r=>{e(r.value)});this.eventListeners.set(n,s),await i.startEnabledNotifications()})}async stopEnabledNotifications(){await this.queue(async()=>{var e;const t="onEnabledChanged";await((e=this.eventListeners.get(t))===null||e===void 0?void 0:e.remove()),this.eventListeners.delete(t),await i.stopEnabledNotifications()})}async isLocationEnabled(){return await this.queue(async()=>(await i.isLocationEnabled()).value)}async openLocationSettings(){await this.queue(async()=>{await i.openLocationSettings()})}async openBluetoothSettings(){await this.queue(async()=>{await i.openBluetoothSettings()})}async openAppSettings(){await this.queue(async()=>{await i.openAppSettings()})}async setDisplayStrings(e){await this.queue(async()=>{await i.setDisplayStrings(e)})}async requestDevice(e){return e=e?this.validateRequestBleDeviceOptions(e):void 0,await this.queue(async()=>await i.requestDevice(e))}async requestLEScan(e,t){e=this.validateRequestBleDeviceOptions(e),await this.queue(async()=>{var n;await((n=this.scanListener)===null||n===void 0?void 0:n.remove()),this.scanListener=await i.addListener("onScanResult",s=>{const r=Object.assign(Object.assign({},s),{manufacturerData:this.convertObject(s.manufacturerData),serviceData:this.convertObject(s.serviceData),rawAdvertisement:s.rawAdvertisement?this.convertValue(s.rawAdvertisement):void 0});t(r)}),await i.requestLEScan(e)})}async stopLEScan(){await this.queue(async()=>{var e;await((e=this.scanListener)===null||e===void 0?void 0:e.remove()),this.scanListener=null,await i.stopLEScan()})}async getDevices(e){if(!Array.isArray(e))throw new Error("deviceIds must be an array");return this.queue(async()=>(await i.getDevices({deviceIds:e})).devices)}async getConnectedDevices(e){if(!Array.isArray(e))throw new Error("services must be an array");return e=e.map(u),this.queue(async()=>(await i.getConnectedDevices({services:e})).devices)}async connect(e,t,n){await this.queue(async()=>{var s;if(t){const r=`disconnected|${e}`;await((s=this.eventListeners.get(r))===null||s===void 0?void 0:s.remove());const o=await i.addListener(r,()=>{t(e)});this.eventListeners.set(r,o)}await i.connect(Object.assign({deviceId:e},n))})}async createBond(e,t){await this.queue(async()=>{await i.createBond(Object.assign({deviceId:e},t))})}async isBonded(e){return await this.queue(async()=>(await i.isBonded({deviceId:e})).value)}async disconnect(e){await this.queue(async()=>{await i.disconnect({deviceId:e})})}async getServices(e){return await this.queue(async()=>(await i.getServices({deviceId:e})).services)}async discoverServices(e){await this.queue(async()=>{await i.discoverServices({deviceId:e})})}async getMtu(e){return await this.queue(async()=>(await i.getMtu({deviceId:e})).value)}async requestConnectionPriority(e,t){await this.queue(async()=>{await i.requestConnectionPriority({deviceId:e,connectionPriority:t})})}async readRssi(e){return await this.queue(async()=>{const n=await i.readRssi({deviceId:e});return parseFloat(n.value)})}async read(e,t,n,s){return t=u(t),n=u(n),await this.queue(async()=>{const o=await i.read(Object.assign({deviceId:e,service:t,characteristic:n},s));return this.convertValue(o.value)})}async write(e,t,n,s,r){return t=u(t),n=u(n),this.queue(async()=>{if(!(s!=null&&s.buffer))throw new Error("Invalid data.");let o=s;m.getPlatform()!=="web"&&(o=g(s)),await i.write(Object.assign({deviceId:e,service:t,characteristic:n,value:o},r))})}async writeWithoutResponse(e,t,n,s,r){t=u(t),n=u(n),await this.queue(async()=>{if(!(s!=null&&s.buffer))throw new Error("Invalid data.");let o=s;m.getPlatform()!=="web"&&(o=g(s)),await i.writeWithoutResponse(Object.assign({deviceId:e,service:t,characteristic:n,value:o},r))})}async readDescriptor(e,t,n,s,r){return t=u(t),n=u(n),s=u(s),await this.queue(async()=>{const c=await i.readDescriptor(Object.assign({deviceId:e,service:t,characteristic:n,descriptor:s},r));return this.convertValue(c.value)})}async writeDescriptor(e,t,n,s,r,o){return t=u(t),n=u(n),s=u(s),this.queue(async()=>{if(!(r!=null&&r.buffer))throw new Error("Invalid data.");let c=r;m.getPlatform()!=="web"&&(c=g(r)),await i.writeDescriptor(Object.assign({deviceId:e,service:t,characteristic:n,descriptor:s,value:c},o))})}async startNotifications(e,t,n,s){t=u(t),n=u(n),await this.queue(async()=>{var r;const o=`notification|${e}|${t}|${n}`;await((r=this.eventListeners.get(o))===null||r===void 0?void 0:r.remove());const c=await i.addListener(o,l=>{s(this.convertValue(l==null?void 0:l.value))});this.eventListeners.set(o,c),await i.startNotifications({deviceId:e,service:t,characteristic:n})})}async stopNotifications(e,t,n){t=u(t),n=u(n),await this.queue(async()=>{var s;const r=`notification|${e}|${t}|${n}`;await((s=this.eventListeners.get(r))===null||s===void 0?void 0:s.remove()),this.eventListeners.delete(r),await i.stopNotifications({deviceId:e,service:t,characteristic:n})})}validateRequestBleDeviceOptions(e){return e.services&&(e.services=e.services.map(u)),e.optionalServices&&(e.optionalServices=e.optionalServices.map(u)),e}convertValue(e){return typeof e=="string"?R(e):e===void 0?new DataView(new ArrayBuffer(0)):e}convertObject(e){if(e===void 0)return;const t={};for(const n of Object.keys(e))t[n]=this.convertValue(e[n]);return t}}const w=new U;let D,f,h="";C.subscribe(a=>{D=a});b.subscribe(a=>{f=a});const y="4fafc201-1fb5-459e-8fcc-c5c9c331914b",v="beb5483e-36e1-4688-b7f5-ea07361b26a8";function M(a,e=500,t=10){let n,s,r;const o=d=>{n=d.clientX,s=d.clientY,r=setTimeout(()=>{a.dispatchEvent(new CustomEvent("longpress"))},e),a.addEventListener("pointermove",c),a.addEventListener("pointerup",l),a.addEventListener("pointerleave",l)},c=d=>{const E=d.clientX-n,L=d.clientY-s;Math.sqrt(E*E+L*L)>t&&l()},l=()=>{clearTimeout(r),a.removeEventListener("pointermove",c),a.removeEventListener("pointerup",l),a.removeEventListener("pointerleave",l)};return a.addEventListener("pointerdown",o),{destroy(){a.removeEventListener("pointerdown",o)}}}function P(a){for(var e=a.toString(),t="",n=0;n<e.length;n+=2)t+=String.fromCharCode(parseInt(e.substr(n,2),16));return t}function I(a,e){try{let t=new Uint8Array(a.buffer).reduce((s,r)=>s+r.toString(16).padStart(2,"0"),"");if(t.startsWith("ff"))h="",t=t.slice(2);else if(h.length<=0)return;let n=P(t);h+=n,n.endsWith("}")&&(V(h,e),h="")}catch(t){alert("error: "+t.message)}}function V(a,e){try{let t=JSON.parse(a);if(console.log("Received JSON:",t),b.set(f.map(n=>n.id===e?{...n,settings:t}:n)),!t.type||!t.value)return;D.update(n=>[...n,{time:new Date().toLocaleTimeString(),name:t.type,message:t.value}])}catch(t){alert("Error parsing JSON:",t)}}async function j(a,e=!1){try{return await w.connect(a,async()=>{b.set(f.map(t=>t.id===a?{...t,status:"Connection Lost"}:t)),await w.stopNotifications(a,y,v)}),await w.startNotifications(a,y,v,t=>{I(t,a)}),await w.write(a,y,v,new Uint8Array([1])),!0}catch(t){return e||alert(t),!1}}async function H(a){w.write(a,y,v,new Uint8Array([241,2])),await w.disconnect(a),await new Promise(t=>setTimeout(t,500)),await j(a,!1)&&b.set(f.map(t=>t.id===a?{...t,status:"connected"}:t))}async function Q(a){let e=f.find(t=>t.id===a);for(w.write(e.id,y,v,new Uint8Array([241,1]));!e.settings;)await new Promise(t=>setTimeout(t,100)),e=f.find(t=>t.id===a);e={...e,...e.settings},b.set(f.map(t=>t.id===a?e:t))}async function X(a){w.write(a,y,v,new Uint8Array([241,3]))}export{w as B,y as a,j as b,v as c,X as f,R as h,M as l,k as m,H as r,Q as s,Y as w};
